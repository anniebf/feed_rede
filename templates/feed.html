{% extends "base.html" %}

{% block content %}
<div class="feed-container">
    <header class="feed-header">
        <h1><i class="fas fa-stream"></i>PostaAi</h1>
        <div class="user-info logged-in-user">
            <div class="user-avatar my-profile-pic-container" data-user-id="{{ session['user_id'] }}">
                <img id="my-profile-pic"
                     src="{{ url_for('static', filename='uploads/' + my_profile_pic) }}"
                     alt="{{ username }}">
                <div class="profile-pic-overlay" id="profile-pic-overlay">
                    <i class="fas fa-camera"></i>
                    <span>Alterar Foto</span>
                </div>
            </div>

            <span>Olá, <strong>{{ username }}</strong>!</span>
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </div>
    </header>

    <div class="main-content">
        <div class="create-post">
            <h3>Criar Nova Postagem</h3>
            <form method="POST" action="{{ url_for('create_post') }}" enctype="multipart/form-data" id="post-form">
                <div class="post-type-selector">
                    <button type="button" class="type-btn active" data-type="text"><i class="fas fa-font"></i> Texto</button>
                    <button type="button" class="type-btn" data-type="image"><i class="fas fa-image"></i> Imagem</button>
                    <button type="button" class="type-btn" data-type="video"><i class="fas fa-video"></i> Vídeo</button>
                </div>

                <div class="form-group">
                    <textarea id="content" name="content" rows="3" placeholder="O que você está pensando?" required></textarea>
                </div>

                <div class="form-group" id="media-upload" style="display: none;">
                    <label for="media">Arquivo:</label>
                    <input type="file" id="media" name="media" accept="image/*,video/*">
                </div>

                <input type="hidden" id="post-type" name="type" value="text">

                <button type="submit" class="btn btn-primary">Postar</button>
            </form>
        </div>

        <div class="posts-section">
            <h3>Postagens Recentes</h3>

            {% if posts %}
                {% for post in posts %}
                <div class="post" data-post-id="{{ post.id }}">
                    <div class="post-header">
                        <div class="user-avatar" data-user-id="{{ post.author.id }}">
                            <img src="{{ url_for('static', filename='uploads/' + post.author.profile_pic) }}" alt="{{ post.author.username }}">
                        </div>
                        <span class="post-username"><strong>{{ post.author.username }}</strong></span>
                        <span class="post-time">{{ post.created_at.strftime('%H:%M - %d/%m') }}</span>
                    </div>

                    <div class="post-content">
                        {% if post.content %}
                            <p class="post-text">{{ post.content }}</p>
                        {% endif %}

                        {% if post.media_path %}
                            {% set media_url = url_for('static', filename='uploads/' + post.media_path) %}
                            {% if post.type == 'image' %}
                                <img src="{{ media_url }}" alt="Post Media" class="post-media-img">
                            {% elif post.type == 'video' %}
                                <video controls class="post-media-video">
                                    <source src="{{ media_url }}" type="video/{{ post.media_path.split('.')[-1] }}">
                                    Seu navegador não suporta a tag de vídeo.
                                </video>
                            {% endif %}
                        {% endif %}
                    </div>

                    <div class="post-footer">
                        <div class="post-actions">
                            <button class="action-btn like-btn" data-post-id="{{ post.id }}"
                                data-is-liked="{{ post.is_liked_by_user | lower }}">
                                <i class="{{ 'fas' if post.is_liked_by_user else 'far' }} fa-heart"></i>
                                <span class="likes-count">{{ post.likes_count }}</span>
                            </button>

                            <button class="action-btn comment-btn" data-post-id="{{ post.id }}">
                                <i class="fas fa-pencil-alt"></i>
                                <span class="comments-count">{{ post.comments | length }}</span>
                            </button>
                        </div>

                        <span class="post-type">
                            </span>
                    </div>

                    <div class="post-comments-container">
                        <div class="comment-form-area" data-post-id="{{ post.id }}" style="display: none;">
                            <textarea placeholder="Adicione um comentário..." class="comment-input" rows="1"></textarea>
                            <button class="btn btn-sm btn-primary submit-comment-btn">Comentar</button>
                        </div>

                        <div class="comments-list">
                            {% for comment in post.comments | sort(attribute='created_at', reverse=false) %}
                                <div class="comment-item">
                                    <span class="comment-username"><strong>{{ comment.author.username }}:</strong></span>
                                    <span class="comment-content">{{ comment.content }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>'

                </div>
                {% endfor %}
            {% else %}
            {% endif %}

        </div>
    </div>
</div>

<form id="upload-form" method="POST" action="{{ url_for('upload_profile_pic') }}" enctype="multipart/form-data" style="display: none;">
    <input type="file" id="profile-pic-input" name="profile_pic_file" accept="image/*">
</form>

<div id="user-popup" class="user-popup"></div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Variáveis Comuns ---
        const userPopup = document.getElementById('user-popup');
        let popupTimeout;

        // --- 1. Controle dos Tipos de Postagem (Mantido) ---
        const typeButtons = document.querySelectorAll('.type-btn');
        const postTypeInput = document.getElementById('post-type');
        const mediaUpload = document.getElementById('media-upload');
        const mediaInput = document.getElementById('media');
        const contentTextarea = document.getElementById('content');

        if (typeButtons.length > 0) {
            typeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove a classe active de todos os botões
                    typeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const type = this.getAttribute('data-type');
                    postTypeInput.value = type;

                    if (type === 'text') {
                        mediaUpload.style.display = 'none';
                        mediaInput.removeAttribute('required');
                        contentTextarea.setAttribute('placeholder', 'O que você está pensando?');
                    } else {
                        mediaUpload.style.display = 'block';
                        mediaInput.setAttribute('required', 'required');

                        if (type === 'image') {
                            mediaInput.setAttribute('accept', 'image/*');
                            contentTextarea.setAttribute('placeholder', 'Descrição da imagem...');
                        } else if (type === 'video') {
                            mediaInput.setAttribute('accept', 'video/*');
                            contentTextarea.setAttribute('placeholder', 'Descrição do vídeo...');
                        }
                    }
                });
            });
        }

        // --- 2. Lógica de Upload da Foto de Perfil (CORREÇÃO DO URL AQUI!) ---
        const myPicContainer = document.querySelector('.my-profile-pic-container');
        const fileInput = document.getElementById('profile-pic-input');
        const profilePicImg = document.getElementById('my-profile-pic');

        if (myPicContainer && fileInput && profilePicImg) {
            // A) Ao clicar no avatar logado, abre o seletor de arquivo
            myPicContainer.addEventListener('click', function() {
                fileInput.click();
            });

            // B) Ao selecionar o arquivo, envia o formulário via Fetch API
            fileInput.addEventListener('change', function() {
                if (fileInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('profile_pic_file', fileInput.files[0]);

                    myPicContainer.style.cursor = 'wait';

                    // O JINJA2 É PROCESSADO AGORA POR ESTAR DENTRO DO TEMPLATE HTML
                    fetch("{{ url_for('upload_profile_pic') }}", {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        myPicContainer.style.cursor = 'pointer';
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || 'Erro no servidor (código ' + response.status + ').');
                            }).catch(() => {
                                throw new Error('Resposta inesperada (HTML/Texto). Verifique o console do Flask.');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            profilePicImg.src = data.new_pic_url;
                            alert(data.message);
                        } else {
                            alert('Erro ao atualizar foto: ' + data.message);
                        }
                    })
                    .catch(error => {
                        myPicContainer.style.cursor = 'pointer';
                        console.error('Erro de upload:', error);
                        alert(`Falha no upload: ${error.message}`);
                    });
                }
            });
        }

        // --- 3. Popup de Informações do Usuário (Mantido) ---
        const userAvatars = document.querySelectorAll('.user-avatar');

        userAvatars.forEach(avatar => {
            const isMyAvatar = avatar.classList.contains('my-profile-pic-container');

            if (isMyAvatar) {
                return;
            }

            avatar.addEventListener('mouseenter', function(e) {
                clearTimeout(popupTimeout);

                const userId = this.getAttribute('data-user-id');
                if (!userId) return;

                fetch(`/get_user_info/${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error(data.error);
                            return;
                        }

                        const rect = this.getBoundingClientRect();
                        userPopup.style.left = `${rect.left + rect.width / 2}px`;
                        userPopup.style.top = `${rect.bottom + 10}px`;
                        userPopup.style.transform = 'translateX(-50%)';

                        userPopup.innerHTML = `
                            <div class="user-popup-header">
                                <img src="${data.profile_pic}" alt="${data.username}">
                                <h4>${data.username}</h4>
                            </div>
                            <div class="user-popup-bio">
                                <p>${data.bio || 'Nenhuma descrição fornecida.'}</p>
                            </div>
                        `;

                        userPopup.classList.add('active');
                    })
                    .catch(error => {
                        console.error('Erro ao buscar informações do usuário:', error);
                    });
            });

            avatar.addEventListener('mouseleave', function() {
                popupTimeout = setTimeout(() => {
                    userPopup.classList.remove('active');
                }, 300);
            });

            avatar.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.dispatchEvent(new Event('mouseenter'));
            });

            avatar.addEventListener('touchend', function(e) {
                e.preventDefault();
                setTimeout(() => {
                    userPopup.classList.remove('active');
                }, 2000);
            });
        });

        userPopup.addEventListener('mouseenter', function() {
            clearTimeout(popupTimeout);
        });

        userPopup.addEventListener('mouseleave', function() {
            this.classList.remove('active');
        });


        // --- 4. Validação do formulário de postagem (Mantido) ---
        const postForm = document.getElementById('post-form');
        if (postForm) {
            postForm.addEventListener('submit', function(e) {
                const postType = postTypeInput.value;
                const content = contentTextarea.value.trim();

                if (postType === 'text' && content === '') {
                    e.preventDefault();
                    alert('Por favor, digite algum conteúdo para sua postagem de texto.');
                    contentTextarea.focus();
                    return;
                }

                if ((postType === 'image' || postType === 'video') && mediaInput.files.length === 0) {
                    e.preventDefault();
                    alert(`Por favor, selecione um arquivo para sua postagem de ${postType === 'image' ? 'imagem' : 'vídeo'}.`);
                    return;
                }
            });
        }


        // --- 5. Lógica de Likes e Comentários (Mantido) ---

        // 5a. Toggle Like (Curtir/Descurtir)
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const isLiked = this.getAttribute('data-is-liked') === 'true';
                const icon = this.querySelector('i');
                const countSpan = this.querySelector('.likes-count');

                // Otimista UI: Atualiza o ícone e a contagem imediatamente
                let currentCount = parseInt(countSpan.textContent);
                if (isLiked) {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    countSpan.textContent = currentCount - 1;
                    this.setAttribute('data-is-liked', 'false');
                } else {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    countSpan.textContent = currentCount + 1;
                    this.setAttribute('data-is-liked', 'true');
                }

                fetch(`/toggle_like/${postId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Falha no servidor.');
                    return response.json();
                })
                .then(data => {
                    // Confirma o estado e a contagem (caso a otimista UI tenha falhado)
                    if (data.success) {
                        icon.classList.toggle('fas', data.liked);
                        icon.classList.toggle('far', !data.liked);
                        countSpan.textContent = data.likes_count;
                        this.setAttribute('data-is-liked', data.liked.toString());
                    } else {
                        // Se falhou, reverte o estado otimista
                        alert('Erro ao curtir: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro de Like:', error);
                    alert('Erro ao processar a curtida.');
                    // Reverte o estado otimista para o estado inicial
                    this.setAttribute('data-is-liked', (!isLiked).toString());
                    icon.classList.toggle('fas', !isLiked);
                    icon.classList.toggle('far', isLiked);
                    countSpan.textContent = currentCount;
                });
            });
        });


        // 5b. Toggle Formulário de Comentário
        document.querySelectorAll('.comment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const commentArea = document.querySelector(`.comment-form-area[data-post-id="${postId}"]`);

                if (commentArea) {
                    // Alterna a visibilidade do formulário
                    const isVisible = commentArea.style.display === 'block';
                    commentArea.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible) {
                        commentArea.querySelector('.comment-input').focus();
                    }
                }
            });
        });


        // 5c. Enviar Comentário
        document.querySelectorAll('.submit-comment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const formArea = this.closest('.comment-form-area');
                const postId = formArea.getAttribute('data-post-id');
                const input = formArea.querySelector('.comment-input');
                const content = input.value.trim();

                if (content.length === 0) {
                    alert('O comentário não pode ser vazio.');
                    return;
                }

                fetch(`/add_comment/${postId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                })
                .then(response => {
                    if (!response.ok) return response.json().then(err => { throw new Error(err.message); });
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 1. Cria o novo elemento HTML para o comentário
                        const newCommentHtml = `
                            <div class="comment-item">
                                <span class="comment-username"><strong>${data.comment.username}:</strong></span>
                                <span class="comment-content">${data.comment.content}</span>
                            </div>
                        `;

                        // 2. Adiciona o comentário à lista
                        const commentsList = document.querySelector(`.post[data-post-id="${postId}"] .comments-list`);
                        commentsList.insertAdjacentHTML('beforeend', newCommentHtml);

                        // 3. Atualiza a contagem de comentários no botão
                        const countSpan = document.querySelector(`.comment-btn[data-post-id="${postId}"] .comments-count`);
                        countSpan.textContent = data.comment.comments_count;

                        // 4. Limpa o input e esconde o formulário
                        input.value = '';
                        formArea.style.display = 'none';
                    } else {
                        alert('Erro ao comentar: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro de Comentário:', error);
                    alert(`Falha ao enviar comentário: ${error.message}`);
                });
            });
        });
    });
</script>

{% endblock %}

{% block extra_styles %}
<style>
/* ... (Seu CSS para os estilos do feed e do avatar, incluindo .my-profile-pic-container) ... */
/* Estilos para o container do avatar no header */
.my-profile-pic-container {
    position: relative;
    width: 50px; /* Ajuste o tamanho do seu avatar */
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    margin-right: 10px;
}

.my-profile-pic-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: filter 0.3s ease;
}

/* Oculta a overlay por padrão */
.profile-pic-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    text-align: center;
    font-size: 0.75em;
    line-height: 1.1;
}

.profile-pic-overlay i {
    font-size: 1.2em;
    margin-bottom: 2px;
}

/* Efeito de hover: a overlay aparece e a imagem escurece */
.my-profile-pic-container:hover .profile-pic-overlay {
    opacity: 1;
}

.my-profile-pic-container:hover img {
    filter: brightness(0.7);
}

.feed-header .user-info {
    display: flex;
    align-items: center;
}
</style>
{% endblock %}